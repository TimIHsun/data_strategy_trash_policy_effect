---
title: "trash-policy"
author: "邱奕勳"
date: "2020/5/14"
output: html_document
---

```{r}
library(dplyr); library(stringr); library(ggplot2); library(plotly); library(lubridate); library(readr); library(tidyr); library(showtext); library(plm)

font_add("QYuan","cwTeXQYuan-Medium.ttf") # 新增字體
showtext_auto(enable=TRUE) #啟用字體
theme_set(theme_classic())
knitr::opts_chunk$set(out.width='80%', fig.asp=.75, fig.align='center', fig.showtext=T)
```

#資料處理
```{r}
trash <- read_csv("rawtrash.csv", col_types = cols(序號 = col_skip()), )

#處理時間
trash$統計期 %>% str_replace_all(c("年"="-","月"="-01")) -> trash$統計期
str_split(trash$統計期, "-") -> trashYearMonth

for (i in 1:length(trashYearMonth)){
  as.integer(trashYearMonth[[i]][[1]])+1911 -> trashYearMonth[[i]][[1]]
  str_c(trashYearMonth[[i]], collapse = "-") -> trashYearMonth[[i]] 
}

trash$統計期 <- trashYearMonth %>% ymd()

#清除na, na為年資料
trash %>% na.omit() ->trash
trash[order(trash$統計期),] -> trash

trash %>% mutate(ratio = trash$`一般垃圾 (公噸)`/trash$`資源垃圾 (公噸)`) -> trash

# treatment; post

trash %>% mutate(
  treat = trash$統計區 == "新北市", 
  post = trash$統計期>ymd("2010-12-01"),
  effect = (treat == 1& post == 1)
  ) ->trash
```

```{r}
#桃園市v新北市
trash %>% filter(trash$統計區== "新北市"|trash$統計區== "桃園市")-> DIDNtpTao

ols<-lm(DIDNtpTao$`平均每人每日一般廢棄物產生量 (公斤)`~ treat+post+effect, data = DIDNtpTao)
summary(ols)


##2017以前
trash %>% filter((trash$統計區== "新北市"|trash$統計區== "桃園市")&trash$統計期<ymd("2017-01-01"))-> DIDNtpTao2
ols2<-lm(DIDNtpTao2$`平均每人每日一般廢棄物產生量 (公斤)`~ treat+post+effect, data = DIDNtpTao2)
summary(ols2)
```

```{r}
#彰化縣v新北市
trash %>% filter(trash$統計區== "彰化縣"|trash$統計區== "新北市")-> DIDNtpChang

ols_ntp_chang<-lm(DIDNtpChang$`平均每人每日一般廢棄物產生量 (公斤)`~ treat+post+effect, data = DIDNtpChang)
summary(ols_ntp_chang)


##2017以前
trash %>% filter((trash$統計區== "新北市"|trash$統計區== "彰化縣")&trash$統計期<ymd("2017-01-01"))-> DIDNtpChang2
ols_ntp_chang_2<-lm(DIDNtpChang2$`平均每人每日一般廢棄物產生量 (公斤)`~ treat+post+effect, data = DIDNtpChang2)
summary(ols_ntp_chang_2)
```

```{r}
newTP <- trash %>% filter(trash$統計區 == "新北市") 
#按照日期排序

Taoyuan <- trash %>% filter(trash$統計區 == "桃園市")

Taipei <- trash %>% filter(trash$統計區 == "臺北市")

Keelung <- trash %>% filter(trash$統計區 == "基隆市")

TaichungO <- trash %>% filter(trash$統計區 == "臺中市(舊)")

Taichung <- trash %>% filter(trash$統計區 == "臺中市")

TainanO <- trash %>% filter(trash$統計區 == "臺南市(舊)")

Tainan <- trash %>% filter(trash$統計區 == "臺南市")

Changhua <- trash %>% filter(trash$統計區 == "彰化縣")
```

#Diff Standard Error
```{r}
trash %>% filter(trash$統計期<ymd("2010-12-01")) ->trashBefore


unique(trashBefore$統計區)[c(2:4,6:7,9:10,12:28)] -> city

list(c(1:length(city)))-> SD
names(SD[[1]]) <- city

for (i in city){
  trashBefore %>% filter(trashBefore$統計區==i) -> control
  sd(control$`平均每人每日一般廢棄物產生量 (公斤)`- newTP$`平均每人每日一般廢棄物產生量 (公斤)`)->SD[[1]][[i]]
  
}


SD[[1]] %>% which.min()
rbind(SD[[1]], rank(SD[[1]])) %>% as.data.frame()-> perdayperpersonSD
rownames(perdayperpersonSD) <- c("新北市","排序")

```

#平均每人每日
```{r}
ggplot(data = Taoyuan,aes(x= Taoyuan$統計期, y= Taoyuan$`平均每人每日一般廢棄物產生量 (公斤)`)) +
  geom_line()+
  geom_vline(xintercept = ymd("2010-01-01"))+labs(x="統計期(年月)", y="平均每人每日")+
  geom_smooth()+
  geom_line(data = newTP ,aes(x= newTP$統計期, y= newTP$`平均每人每日一般廢棄物產生量 (公斤)`), color = "red")+
  geom_smooth(data = newTP, aes(x= newTP$統計期, y= newTP$`平均每人每日一般廢棄物產生量 (公斤)`))
```

```{r}
ggplot(data = Changhua,aes(x= Changhua$統計期, y= Changhua$`平均每人每日一般廢棄物產生量 (公斤)`)) +
  geom_line()+
  geom_vline(xintercept = ymd("2010-01-01"))+labs(x="統計期(年月)", y="平均每人每日")+
  geom_smooth()+
  geom_line(data = newTP ,aes(x= newTP$統計期, y= newTP$`平均每人每日一般廢棄物產生量 (公斤)`), color = "red")+
  geom_smooth(data = newTP, aes(x= newTP$統計期, y= newTP$`平均每人每日一般廢棄物產生量 (公斤)`))
```

#一般垃圾
```{r}
ggplot(data = Taoyuan,aes(x= Taoyuan$統計期, y= Taoyuan$`一般垃圾 (公噸)`)) +
  geom_line()+
  geom_vline(xintercept = ymd("2010-01-01"))+labs(x="統計期(年月)", y="一般垃圾")+
  geom_smooth()+
  geom_line(data = newTP ,aes(x= newTP$統計期, y= newTP$`一般垃圾 (公噸)`), color = "red")+
  geom_smooth(data = newTP, aes(x= newTP$統計期, y= newTP$`一般垃圾 (公噸)`))
```

```{r}
ggplot(data = Taipei,aes(x= Taipei$統計期, y= Taipei$`一般垃圾 (公噸)`)) +
  geom_line()+
  geom_vline(xintercept = ymd("2010-01-01"))+labs(x="統計期(年月)", y="一般垃圾")+
  geom_smooth()+
  geom_line(data = newTP ,aes(x= newTP$統計期, y= newTP$`一般垃圾 (公噸)`), color = "red")+
  geom_smooth(data = newTP, aes(x= newTP$統計期, y= newTP$`一般垃圾 (公噸)`))
```

```{r}
newTP$`平均每人每日一般廢棄物產生量 (公斤)`%>%outliers::outlier()
```
